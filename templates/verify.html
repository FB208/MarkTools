{% extends "_base.html" %}

{% block title %}文稿校验{% endblock %}

{% block head %}
{{ super() }}
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js"></script>
<style>
  .content-wrapper {
    width: 100%;
    display: flex;
    justify-content: space-between;
    margin-left: -20px;
  }

  .left-panel,
  .right-panel {
    width: 48%;
    display: flex;
    flex-direction: column;
    padding-left: 20px;
  }

  .textarea-container {
    height: calc(100vh - 250px);
    width: 100%;
  }

  #article-content,
  #verify-result {
    width: 100%;
    height: 100%;
    resize: none;
    background-color: rgba(255, 255, 255, 0.05);
    color: #e3e3e3;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    padding: 15px;
    font-size: 16px;
    line-height: 1.6;
  }

  #article-content:focus,
  #verify-result:focus {
    outline: none;
    border-color: #6366f1;
    box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
  }

  .panel-title {
    font-size: 1.2em;
    color: #a5b4fc;
    margin-bottom: 10px;
    text-align: center;
  }

  .word-count {
    text-align: right;
    font-size: 14px;
    color: #a5b4fc;
    margin-top: 5px;
  }

  /* 添加错误标记样式 */
  .error-mark {
    border-bottom: 2px solid red;
    background-color: transparent;
  }
</style>
{% endblock %}

{% block body %}
<div class="container mx-auto px-4 py-8">
  <a href="{{ url_for('main.home') }}" class="home-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6">
      <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
      <polyline points="9 22 9 12 15 12 15 22"></polyline>
    </svg>
  </a>
  <div class="flex flex-col items-center w-full max-w-6xl bg-white bg-opacity-5 backdrop-blur-md rounded-2xl p-8 shadow-lg">
    <h1 class="title">文稿校验</h1>
    <div class="content-wrapper">
      <div class="left-panel">
        <div class="panel-title">原文</div>
        <div class="textarea-container">
          <div id="article-content" contenteditable="true" class="editable-content"></div>
        </div>
        <div id="left-word-count" class="word-count">0 字</div>
      </div>
      <div class="right-panel">
        <div class="panel-title">校验结果</div>
        <div class="textarea-container">
          <div id="verify-result"></div>
        </div>
        <div id="right-word-count" class="word-count">0 字</div>
      </div>
    </div>
  </div>
</div>

<script>
$(document).ready(function() {
  const articleContent = document.getElementById('article-content');
  const markInstance = new Mark(articleContent);

  function updateWordCount() {
    const wordCount = articleContent.innerText.length;
    $('#left-word-count').text(wordCount + ' 字');
  }

  function highlightErrors(errors) {
    markInstance.unmark(); // 清除之前的标记
    errors.forEach(error => {
      markInstance.mark(error.word, {
        className: 'error-mark',
        acrossElements: true,
        separateWordSearch: false,
        each: function(element) {
          element.setAttribute('title', error.suggestion);
        }
      });
    });
  }

  articleContent.addEventListener('input', function() {
    updateWordCount();
    // 这里可以添加发送文本到后端进行校验的逻辑
    // 例如使用防抖函数来控制请求频率
  });

  // 模拟错误检测结果
  const simulateErrorCheck = () => {
    const text = articleContent.innerText;
    const errors = [
      { word: '错误', suggestion: '这是一个错别字' },
      { word: '有问题', suggestion: '这个短语可能有问题' }
    ];
    highlightErrors(errors);
  };

  // 为了演示,我们在输入后延迟1秒模拟错误检查
  let timer;
  articleContent.addEventListener('input', function() {
    clearTimeout(timer);
    timer = setTimeout(simulateErrorCheck, 1000);
  });
});
</script>
{% endblock %}
