{% extends "_base.html" %}

{% block title %}小红书图片文案生成{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<!-- CodeMirror 5 (更轻量级) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/theme/monokai.css">
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/xml/xml.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/css/css.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/htmlmixed/htmlmixed.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/addon/edit/closetag.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/addon/edit/matchtags.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/addon/fold/xml-fold.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/addon/fold/foldcode.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/addon/fold/foldgutter.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/addon/fold/foldgutter.css">
<style>
  .redbook-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
    max-width: 1600px;
    height: calc(100vh - 120px);
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 30px;
    box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
    overflow: hidden;
  }

  .redbook-area {
    display: flex;
    justify-content: center;
    align-items: flex-start;
    width: 100%;
    height: calc(100% - 80px);
    gap: 30px;
    overflow: hidden;
  }

  .input-container {
    flex: 1;
    max-width: 50%;
    height: 100%;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .input-textarea {
    width: 100%;
    flex: 1;
    min-height: 200px;
    border: 1px solid rgba(255, 255, 255, 0.18);
    background-color: rgba(255, 255, 255, 0.05);
    color: #e3e3e3;
    border-radius: 12px;
    padding: 16px;
    font-size: 16px;
    resize: none;
    transition: all 0.3s ease;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    overflow-y: auto;
  }

  .input-textarea:focus {
    outline: none;
    box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.6);
  }

  .output-container {
    flex: 1;
    max-width: 50%;
    height: 100%;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
    padding-right: 5px;
  }

  .generated-text {
    background: rgba(255, 255, 255, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.18);
    border-radius: 12px;
    padding: 16px;
    color: #e3e3e3;
    font-size: 16px;
    line-height: 1.6;
    white-space: pre-wrap;
    min-height: 120px;
    display: none;
    flex-shrink: 0;
  }

  .generated-pics {
    display: flex;
    flex-direction: column;
    gap: 15px;
  }

  .pic-item {
    background: rgba(255, 255, 255, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.18);
    border-radius: 12px;
    padding: 20px;
    overflow: hidden;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
  }

  .generate-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 12px;
    padding: 12px 24px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    width: 100%;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .generate-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
  }

  .generate-btn:disabled {
    background: rgba(255, 255, 255, 0.1);
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  .loading {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s ease-in-out infinite;
    margin-right: 8px;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  label {
    color: #a5b4fc;
    margin-bottom: 8px;
    display: block;
    font-weight: 500;
    text-shadow: 0 0 3px #a5b4fc;
  }

  .action-buttons {
    display: flex;
    flex-direction: column;
    gap: 10px;
    min-height: 68px;
  }

  .action-btn {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 10px 16px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    height: 48px;
  }

  .action-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
  }

  .action-btn:disabled {
    background: rgba(255, 255, 255, 0.1);
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  .action-btn.download-btn {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  }

  .action-btn.download-btn:hover {
    box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
  }

  .status-text {
    color: #10b981;
    font-size: 14px;
    margin: 0;
    display: none;
    text-align: center;
    padding: 8px 12px;
    background: rgba(16, 185, 129, 0.1);
    border-radius: 8px;
    border: 1px solid rgba(16, 185, 129, 0.2);
    font-weight: 500;
  }

  /* 进度条样式 */
  .progress-container {
    display: none;
    margin: 10px 0;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    overflow: hidden;
    height: 6px;
  }

  .progress-bar {
    height: 100%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    width: 0%;
    transition: width 0.5s ease;
    border-radius: 8px;
    position: relative;
  }

  .progress-bar::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    animation: progress-shimmer 1.5s infinite;
  }

  @keyframes progress-shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
  }

  .progress-text {
    color: #a5b4fc;
    font-size: 12px;
    margin-top: 5px;
    text-align: center;
  }

  /* 滚动条样式 */
  .input-textarea::-webkit-scrollbar,
  .output-container::-webkit-scrollbar {
    width: 8px;
  }

  .input-textarea::-webkit-scrollbar-track,
  .output-container::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
  }

  .input-textarea::-webkit-scrollbar-thumb,
  .output-container::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.3);
    border-radius: 4px;
  }

  .input-textarea::-webkit-scrollbar-thumb:hover,
  .output-container::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.5);
  }

  /* 编辑按钮样式 */
  .edit-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: rgba(0, 0, 0, 0.6);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    opacity: 0;
    transition: all 0.3s ease;
    z-index: 10;
  }

  .pic-item:hover .edit-btn {
    opacity: 1;
  }

  .edit-btn:hover {
    background: rgba(0, 0, 0, 0.8);
    transform: scale(1.1);
  }

  /* 编辑弹窗样式 */
  .edit-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(10px);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }

  .edit-modal.active {
    display: flex;
  }

  .edit-modal-content {
    width: 90%;
    max-width: 1500px;
    height: 92vh;
    max-height: 920px;
    background: rgba(30, 30, 40, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 20px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
  }

  .edit-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 25px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    background: rgba(255, 255, 255, 0.03);
    flex-shrink: 0;
  }

  .edit-modal-title {
    color: #e3e3e3;
    font-size: 20px;
    font-weight: 600;
  }

  .edit-modal-close {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.1);
    border: none;
    color: #e3e3e3;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .edit-modal-close:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: rotate(90deg);
  }

  .edit-modal-body {
    flex: 1;
    display: flex;
    gap: 15px;
    padding: 15px;
    overflow: hidden;
    min-height: 0;
  }

  .edit-preview-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .edit-preview-label {
    color: #a5b4fc;
    font-weight: 500;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .zoom-controls {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .zoom-btn {
    width: 28px;
    height: 28px;
    border-radius: 4px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: #a5b4fc;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 12px;
    font-weight: 500;
  }

  .zoom-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: scale(1.05);
  }

  .zoom-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
    transform: none;
  }

  .zoom-text {
    color: #a5b4fc;
    font-size: 12px;
    font-weight: 500;
    min-width: 40px;
    text-align: center;
  }

  .edit-preview-wrapper {
    flex: 1;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    min-height: 0;
  }

  .edit-preview-content {
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    /* 设置为原始600*800尺寸，然后缩放75%显示为450*600 */
    width: 600px;
    height: 800px;
    transform: scale(0.75);
    transform-origin: center center;
    flex-shrink: 0;
    overflow: hidden;
  }

  /* 确保预览内容里的元素正确显示 */
  .edit-preview-content > * {
    width: 100% !important;
    height: 100% !important;
    max-width: none !important;
    max-height: none !important;
  }

  .edit-code-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .edit-code-label {
    color: #a5b4fc;
    font-weight: 500;
    font-size: 14px;
  }

  .edit-code-textarea {
    flex: 1;
    width: 100%;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 16px;
    color: #e3e3e3;
    font-family: 'Courier New', Courier, monospace;
    font-size: 14px;
    line-height: 1.6;
    resize: none;
    overflow-y: auto;
  }

  .edit-code-textarea:focus {
    outline: none;
    border-color: rgba(79, 70, 229, 0.6);
    box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
  }

  /* CodeMirror 编辑器样式 */
  .CodeMirror {
    flex: 1;
    height: auto;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 0 0 12px 12px;
    border-top: none;
    font-size: 14px;
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    background: rgba(0, 0, 0, 0.3) !important;
  }

  .CodeMirror:focus-within {
    border-color: rgba(79, 70, 229, 0.6);
    box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
  }

  .CodeMirror-scroll {
    min-height: 100%;
  }

  .CodeMirror-gutters {
    background: rgba(0, 0, 0, 0.4) !important;
    border-right: 1px solid rgba(255, 255, 255, 0.1);
  }

  .CodeMirror-linenumber {
    color: rgba(255, 255, 255, 0.5) !important;
  }

  /* 编辑器工具栏样式 */
  .edit-toolbar {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-bottom: none;
    border-radius: 12px 12px 0 0;
    flex-shrink: 0;
  }

  .toolbar-btn {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    background: rgba(255, 255, 255, 0.1);
    border: none;
    color: #e3e3e3;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 14px;
  }

  .toolbar-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: scale(1.05);
  }

  .toolbar-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
    transform: none;
  }

  .toolbar-btn:disabled:hover {
    background: rgba(255, 255, 255, 0.1);
  }

  .toolbar-separator {
    width: 1px;
    height: 24px;
    background: rgba(255, 255, 255, 0.2);
    margin: 0 4px;
  }

  /* 错误提示样式 */
  .error-indicator {
    display: none;
    color: #ff6b6b;
    font-size: 12px;
    padding: 4px 8px;
    background: rgba(255, 107, 107, 0.1);
    border: 1px solid rgba(255, 107, 107, 0.3);
    border-radius: 4px;
    margin-left: auto;
    flex-shrink: 0;
  }

  .error-indicator.show {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .syntax-error {
    border-color: rgba(255, 107, 107, 0.5) !important;
  }

  .edit-modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    padding: 15px 25px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    background: rgba(255, 255, 255, 0.03);
    flex-shrink: 0;
  }

  .edit-modal-btn {
    padding: 10px 24px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    border: none;
  }

  .edit-modal-btn.cancel {
    background: rgba(255, 255, 255, 0.1);
    color: #e3e3e3;
  }

  .edit-modal-btn.cancel:hover {
    background: rgba(255, 255, 255, 0.15);
  }

  .edit-modal-btn.save {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }

  .edit-modal-btn.save:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
  }

  /* 新的 iframe 预览容器，按 3:4 占位 */
  .iframe-shell {
    width: 600px;
    height: 800px;
    border-radius: 8px;
    overflow: hidden; /* 仅裁切容器边缘 */
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    position: relative;
    display: block;
    /* transform: scale(0.75); */
  }
  /* 让 iframe 占满容器，取消外层旧样式的缩放干扰 */
  .iframe-shell > iframe {
    width: 100% !important;
    height: 100% !important;
    border: 0 !important;
    transform: none !important;
    display: block;
  }

</style>
{% endblock %}

{% block body %}
<div class="container">
  <a href="{{ url_for('main.home') }}" class="home-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6">
      <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
      <polyline points="9 22 9 12 15 12 15 22"></polyline>
    </svg>
  </a>

  <div class="redbook-content">
    <h1 class="title">小红书图片文案生成</h1>

    <div class="redbook-area">
      <!-- 左侧输入区域 -->
      <div class="input-container">
        <!-- 生成按钮 -->
        <div class="action-buttons">
          <button id="generateBtn" class="generate-btn" onclick="generateRedbook()">
            生成
          </button>
          <div id="statusText" class="status-text"></div>
          <div id="progressContainer" class="progress-container">
            <div id="progressBar" class="progress-bar"></div>
            <div id="progressText" class="progress-text">0%</div>
          </div>
        </div>
        
        <label for="textInput">输入文案内容</label>
        <textarea
          id="textInput"
          class="input-textarea"
          placeholder="请输入你想要生成小红书内容的原始文案..."
        ></textarea>
      </div>

      <!-- 右侧输出区域 -->
      <div class="output-container">
        <!-- 功能按钮 -->
        <div id="actionButtons" class="action-buttons" style="display: none; flex-direction: row; min-height: 68px;">
          <button class="action-btn" onclick="copyText()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            复制文案
          </button>
          <button class="action-btn download-btn" onclick="downloadAllImages()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            下载图片
          </button>
        </div>

        <!-- 生成的文案 -->
        <div>
          <label>生成的文案</label>
          <div id="generatedText" class="generated-text"></div>
        </div>

        <!-- 生成的图片 -->
        <div style="margin-top: 10px;">
          <label>生成的图片</label>
          <div id="generatedPics" class="generated-pics">
            <!-- 动态生成的图片内容会插入到这里 -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 编辑弹窗 -->
<div id="editModal" class="edit-modal">
  <div class="edit-modal-content">
    <div class="edit-modal-header">
      <h3 class="edit-modal-title">编辑图片HTML</h3>
      <button class="edit-modal-close" onclick="closeEditModal()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="edit-modal-body">
      <!-- 左侧预览 -->
      <div class="edit-preview-container">
        <label class="edit-preview-label">
          <span>实时预览</span>
          <div class="zoom-controls">
            <button id="zoomOutBtn" class="zoom-btn" title="缩小" onclick="zoomPreview(-0.25)">-</button>
            <span id="zoomText" class="zoom-text">75%</span>
            <button id="zoomInBtn" class="zoom-btn" title="放大" onclick="zoomPreview(0.25)">+</button>
            <button id="zoomResetBtn" class="zoom-btn" title="重置" onclick="resetZoom()" style="width: auto; padding: 0 8px;">重置</button>
          </div>
        </label>
        <div class="edit-preview-wrapper">
          <div id="editPreview" class="edit-preview-content">
            <!-- 预览内容 -->
          </div>
        </div>
      </div>
      <!-- 右侧代码编辑 -->
      <div class="edit-code-container">
        <label class="edit-code-label">HTML代码</label>
        <div class="edit-toolbar">
          <button id="undoBtn" class="toolbar-btn" title="撤销 (Ctrl+Z)" onclick="editorUndo()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 7v6h6"></path>
              <path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"></path>
            </svg>
          </button>
          <button id="redoBtn" class="toolbar-btn" title="重做 (Ctrl+Y)" onclick="editorRedo()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 7v6h-6"></path>
              <path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3L21 13"></path>
            </svg>
          </button>
          <div class="toolbar-separator"></div>
          <span style="color: #a5b4fc; font-size: 12px;">Ctrl+S 保存 | Esc 关闭</span>
          <div id="errorIndicator" class="error-indicator">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="15" y1="9" x2="9" y2="15"></line>
              <line x1="9" y1="9" x2="15" y2="15"></line>
            </svg>
            <span id="errorText">语法错误</span>
          </div>
        </div>
        <textarea id="editCode" class="edit-code-textarea" placeholder="在此编辑HTML代码..."></textarea>
      </div>
    </div>
    <div class="edit-modal-footer">
      <button class="edit-modal-btn cancel" onclick="closeEditModal()">取消</button>
      <button class="edit-modal-btn save" onclick="saveEditChanges()">保存更改</button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// 存储当前编辑的图片元素
let currentEditingPicItem = null;
let codeEditor = null;
let progressInterval = null;
let currentProgress = 0;
let currentZoom = 0.75; // 默认75%缩放

// 为输入框添加回车快捷键
document.getElementById('textInput').addEventListener('keydown', function(e) {
  if (e.ctrlKey && e.key === 'Enter') {
    e.preventDefault();
    generateRedbook();
  }
});

// 构建隔离的 srcdoc，去除默认边距，避免 iframe 内出现空白
function buildIsolatedSrcdoc(rawHtml, scale = 1) {
  // 简化：直接渲染用户 HTML，但去掉默认边距以避免多余空白
  return `<!DOCTYPE html><html><head><meta charset="utf-8"><style>
    html,body{margin:0;padding:0;background:transparent;}
  </style></head><body>${rawHtml}</body></html>`;
  // 旧实现（含 scale 与画布包裹）保留注释以便回滚
  // const safeScale = Math.max(0.1, Math.min(2, scale));
  // return `<!DOCTYPE html><html><head><meta charset="utf-8"><style>
  //   html,body{margin:0;padding:0;background:transparent;height:100%;}
  //   *{box-sizing:border-box;}
  //   .canvas{width:600px;height:800px;transform:scale(${safeScale});transform-origin:top left;}
  //   .fit{display:flex;align-items:center;justify-content:center;width:100%;height:100%;}
  // </style></head><body><div class="fit"><div class="canvas">${rawHtml}</div></div></body></html>`;
}

// 列表专用：带缩放的隔离模板，保证 600x800 内容按容器宽度等比显示
function buildListSrcdoc(rawHtml, scale) {
  return rawHtml
  const safeScale = Math.max(0.1, Math.min(3, Number(scale) || 1));
  return `<!DOCTYPE html><html><head><meta charset=\"utf-8\"><style>
    html,body{margin:0;padding:0;background:transparent;height:100%;}
    *{box-sizing:border-box;}
    .canvas{width:600px;height:800px;transform:scale(${safeScale});transform-origin:top left;}
    .fit{display:flex;align-items:center;justify-content:center;width:100%;height:100%;}
  </style></head><body><div class=\"fit\"><div class=\"canvas\">${rawHtml}</div></div></body></html>`;
}

function generateRedbook() {
  const textInput = document.getElementById('textInput');
  const generateBtn = document.getElementById('generateBtn');
  const statusText = document.getElementById('statusText');
  const generatedText = document.getElementById('generatedText');
  const generatedPics = document.getElementById('generatedPics');

  const textContent = textInput.value.trim();

  if (!textContent) {
    showToast('请输入文案内容', 'warning');
    return;
  }

  // 重置输出区域
  generatedText.style.display = 'none';
  generatedText.textContent = '';
  generatedPics.innerHTML = '';
  document.getElementById('actionButtons').style.display = 'none';

  // 更新按钮状态
  generateBtn.disabled = true;
  generateBtn.innerHTML = '<span class="loading"></span>生成中...';
  statusText.style.display = 'block';
  statusText.textContent = '正在连接服务器...';

  // 显示进度条并开始虚拟进度动画
  showProgressBar();
  startVirtualProgress();

  // 注意：使用fetch API，连接会自动管理

  // 使用fetch API处理SSE流
  const url = '/html2pic/generate_redbook';
  const requestData = {
    text_content: textContent
  };

  fetch(url, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(requestData)
  }).then(response => {
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const reader = response.body.getReader();
    const decoder = new TextDecoder();

    function processText({ done, value }) {
      if (done) {
        console.log('SSE流结束');
        return;
      }

      const chunk = decoder.decode(value, { stream: true });
      const lines = chunk.split('\n');

      for (let line of lines) {
        if (line.startsWith('data: ')) {
          try {
            const jsonStr = line.substring(6); // 去掉 "data: " 前缀
            if (jsonStr.trim()) {
              const data = JSON.parse(jsonStr);
              console.log('收到数据:', data);

              switch(data.type) {
                case 'heartbeat':
                  statusText.textContent = data.content;
                  break;

                case 'text':
                  // 显示生成的文案
                  generatedText.textContent = data.content;
                  generatedText.style.display = 'block';
                  document.getElementById('actionButtons').style.display = 'flex';
                  document.getElementById('actionButtons').style.flexDirection = 'row';
                  document.getElementById('actionButtons').style.minHeight = '68px';
                  statusText.textContent = '文案生成完成，正在生成图片...';
                  break;

                case 'pic':
                  // 显示生成的图片HTML
                  const picItem = document.createElement('div');
                  picItem.className = 'pic-item';
                  // 使用 iframe-shell 隔离外层样式
                  const previewContainer = document.createElement('div');
                  previewContainer.className = 'iframe-shell';
                  // 保存原始HTML用于编辑/下载
                  previewContainer.dataset.rawHtml = data.content;

                  const iframe = document.createElement('iframe');
                  iframe.setAttribute('frameborder', '0');
                  iframe.setAttribute('scrolling', 'no');

                  // 先挂载再测量，避免宽度为0
                  previewContainer.appendChild(iframe);
                  picItem.appendChild(previewContainer);
                  generatedPics.appendChild(picItem);

                  // 以 600px 画布宽为基准计算比例
                  const width = previewContainer.getBoundingClientRect().width || 450;
                  const scale = width / 600;
                  iframe.srcdoc = buildListSrcdoc(data.content, scale);

                  // 添加编辑按钮
                  const editBtn = document.createElement('button');
                  editBtn.className = 'edit-btn';
                  editBtn.onclick = function() { openEditModal(picItem); };
                  editBtn.innerHTML = `
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                      <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                  `;
                  picItem.appendChild(editBtn);

                  statusText.textContent = `已生成 ${generatedPics.children.length} 张图片...`;
                  break;

                case 'done':
                  // 生成完成
                  statusText.textContent = '所有内容生成完成！';
                  completeProgress();
                  resetButton();
                  showToast('生成完成！', 'success');
                  return;

                default:
                  console.log('未知消息类型:', data.type);
              }
            }
          } catch (error) {
            console.error('解析SSE数据失败:', error, '原始数据:', line);
          }
        }
      }

      // 继续读取下一块数据
      return reader.read().then(processText);
    }

    return reader.read().then(processText);
  }).catch(error => {
    console.error('请求失败:', error);
    statusText.textContent = '请求失败';
    hideProgressBar();
    resetButton();
    showToast('生成过程中出现错误，请重试', 'error');
  });
}

function resetButton() {
  const generateBtn = document.getElementById('generateBtn');
  const statusText = document.getElementById('statusText');

  generateBtn.disabled = false;
  generateBtn.innerHTML = '生成';

  setTimeout(() => {
    statusText.style.display = 'none';
  }, 3000);
}

// 进度条控制函数
function showProgressBar() {
  const progressContainer = document.getElementById('progressContainer');
  const progressBar = document.getElementById('progressBar');
  const progressText = document.getElementById('progressText');

  progressContainer.style.display = 'block';
  progressBar.style.width = '0%';
  progressText.textContent = '0%';
  currentProgress = 0;
}

function hideProgressBar() {
  const progressContainer = document.getElementById('progressContainer');
  progressContainer.style.display = 'none';
  if (progressInterval) {
    clearInterval(progressInterval);
    progressInterval = null;
  }
}

function startVirtualProgress() {
  if (progressInterval) {
    clearInterval(progressInterval);
  }

  currentProgress = 0;
  progressInterval = setInterval(() => {
    // 虚拟进度算法：快速到达80%，然后缓慢增长
    if (currentProgress < 20) {
      currentProgress += Math.random() * 8 + 2; // 2-10%递增
    } else if (currentProgress < 50) {
      currentProgress += Math.random() * 5 + 1; // 1-6%递增
    } else if (currentProgress < 80) {
      currentProgress += Math.random() * 3 + 0.5; // 0.5-3.5%递增
    } else if (currentProgress < 95) {
      currentProgress += Math.random() * 1; // 0-1%递增
    }

    currentProgress = Math.min(currentProgress, 95); // 最多到95%
    updateProgress(currentProgress);
  }, 800);
}

function completeProgress() {
  if (progressInterval) {
    clearInterval(progressInterval);
    progressInterval = null;
  }

  updateProgress(100);
  setTimeout(() => {
    hideProgressBar();
  }, 2000);
}

function updateProgress(percentage) {
  const progressBar = document.getElementById('progressBar');
  const progressText = document.getElementById('progressText');

  progressBar.style.width = percentage + '%';
  progressText.textContent = Math.round(percentage) + '%';
}

// 页面卸载时的清理工作（fetch API会自动处理）

// 复制文案功能
function copyText() {
  const generatedText = document.getElementById('generatedText');
  const textContent = generatedText.textContent;
  
  if (!textContent.trim()) {
    showToast('没有可复制的文案内容', 'warning');
    return;
  }
  
  navigator.clipboard.writeText(textContent).then(() => {
    showToast('文案已复制到剪贴板', 'success');
  }).catch(err => {
    console.error('复制失败:', err);
    // 备用复制方法
    const textArea = document.createElement('textarea');
    textArea.value = textContent;
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand('copy');
    document.body.removeChild(textArea);
    showToast('文案已复制到剪贴板', 'success');
  });
}

// 下载所有图片功能
function downloadAllImages() {
  const generatedPics = document.getElementById('generatedPics');
  const picItems = generatedPics.querySelectorAll('.pic-item > div:first-child');
  
  if (picItems.length === 0) {
    showToast('没有可下载的图片', 'warning');
    return;
  }
  
  const downloadBtn = document.querySelector('.download-btn');
  
  // 禁用按钮防止重复点击
  downloadBtn.disabled = true;
  downloadBtn.innerHTML = `
    <span class="loading"></span>
    打包中...
  `;
  
  // 收集每张图片的HTML（读取每个项内 iframe 的 srcdoc）
  const htmlList = Array.from(picItems).map(node => {
    const iframe = node.querySelector('iframe');
    return iframe ? (iframe.srcdoc || '') : node.outerHTML;
  });

  // 调用后端生成ZIP
  fetch('/html2pic/download_images', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      html_list: htmlList,
      width: 600,
      height: 800,
      watermark_text: '',
      watermark_image_url: ''
    })
  }).then(async (response) => {
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }

    // 获取文件名
    const disposition = response.headers.get('Content-Disposition') || '';
    let filename = `小红书图片集_${new Date().getTime()}.zip`;
    const match = disposition.match(/filename\*=UTF-8''([^;]+)|filename="?([^";]+)"?/i);
    if (match) {
      filename = decodeURIComponent(match[1] || match[2] || filename);
    }

    const blob = await response.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);

    resetDownloadButton(downloadBtn);
    showToast(`成功下载${picItems.length}张图片`, 'success');
  }).catch(err => {
    console.error('下载失败:', err);
    resetDownloadButton(downloadBtn);
    showToast('下载失败，请重试', 'error');
  });
}

// 恢复下载按钮状态
function resetDownloadButton(button) {
  button.disabled = false;
  button.innerHTML = `
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
      <polyline points="7 10 12 15 17 10"></polyline>
      <line x1="12" y1="15" x2="12" y2="3"></line>
    </svg>
    下载图片
  `;
}

// 打开编辑弹窗
function openEditModal(picItem) {
  const modal = document.getElementById('editModal');
  const editCode = document.getElementById('editCode');
  const editPreview = document.getElementById('editPreview');

  // 保存当前编辑的图片元素
  currentEditingPicItem = picItem;

  // 获取图片内容的HTML（从 iframe 的 srcdoc 读取）
  const iframeEl = picItem.querySelector('iframe');
  const htmlContent = iframeEl ? (iframeEl.srcdoc || '') : '';

  // 初始化CodeMirror编辑器（如果还没有）
  if (!codeEditor) {
    codeEditor = CodeMirror.fromTextArea(editCode, {
      mode: 'htmlmixed',
      theme: 'monokai',
      lineNumbers: true,
      autoCloseTags: true,
      matchTags: true,
      foldGutter: true,
      gutters: ['CodeMirror-linenumbers', 'CodeMirror-foldgutter'],
      indentUnit: 2,
      tabSize: 2,
      lineWrapping: true,
      extraKeys: {
        'Ctrl-S': function() { saveEditChanges(); },
        'Esc': function() { closeEditModal(); }
      }
    });

    // 监听编辑器内容变化
    codeEditor.on('change', function() {
      const code = codeEditor.getValue();
      validateHTML(code);
      updateUndoRedoButtons();
    });
  }

  // 设置代码编辑器的内容
  const formattedHTML = formatHTML(htmlContent);
  codeEditor.setValue(formattedHTML);

  // 设置预览内容为 iframe 隔离渲染
  editPreview.innerHTML = '';
  const previewIframe = document.createElement('iframe');
  previewIframe.setAttribute('frameborder', '0');
  previewIframe.setAttribute('scrolling', 'no');
  previewIframe.style.width = '100%';
  previewIframe.style.height = '100%';
  previewIframe.style.border = '0';
  // 弹窗内不做内部缩放，统一由外层容器 transform 控制
  previewIframe.srcdoc = buildIsolatedSrcdoc(htmlContent, 1);
  editPreview.appendChild(previewIframe);

  // 显示弹窗
  modal.classList.add('active');

  // 刷新编辑器显示
  setTimeout(() => {
    if (codeEditor) {
      codeEditor.refresh();
      codeEditor.focus();
      updateUndoRedoButtons();
    }
    // 初始化缩放控制
    currentZoom = 0.75;
    updatePreviewZoom();
  }, 100);
}

// 关闭编辑弹窗
function closeEditModal() {
  const modal = document.getElementById('editModal');
  modal.classList.remove('active');
  currentEditingPicItem = null;
}

// 保存编辑的更改
function saveEditChanges() {
  if (!currentEditingPicItem) return;

  const newHTML = codeEditor ? codeEditor.getValue() : document.getElementById('editCode').value;

  try {
    // 创建临时容器来验证HTML
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = newHTML;

    // 移除旧的内容（保留编辑按钮）
    const oldContent = currentEditingPicItem.querySelector('div');
    if (oldContent) {
      oldContent.remove();
    }

    // 插入新的内容（在编辑按钮之前）
    const editBtn = currentEditingPicItem.querySelector('.edit-btn');
    currentEditingPicItem.insertBefore(tempDiv.firstElementChild, editBtn);

    // 关闭弹窗
    closeEditModal();

    // 显示成功提示
    showToast('图片已更新', 'success');
  } catch (error) {
    console.error('保存失败:', error);
    showToast('HTML格式有误，请检查后重试', 'error');
  }
}

// 格式化HTML代码
function formatHTML(html) {
  let formatted = html;
  let indent = 0;

  // 简单的格式化，添加换行和缩进
  formatted = formatted.replace(/></g, '>\n<');

  // 分割成行
  const lines = formatted.split('\n');
  const formattedLines = [];

  for (let line of lines) {
    line = line.trim();

    // 处理结束标签
    if (line.startsWith('</')) {
      indent = Math.max(0, indent - 1);
    }

    // 添加缩进
    formattedLines.push('  '.repeat(indent) + line);

    // 处理开始标签
    if (line.startsWith('<') && !line.startsWith('</') && !line.endsWith('/>') && !line.includes('</')) {
      indent++;
    }
  }

  return formattedLines.join('\n');
}

// 编辑器撤销/重做功能
function editorUndo() {
  if (codeEditor) {
    codeEditor.undo();
    updateUndoRedoButtons();
  }
}

function editorRedo() {
  if (codeEditor) {
    codeEditor.redo();
    updateUndoRedoButtons();
  }
}

function updateUndoRedoButtons() {
  if (!codeEditor) return;

  const undoBtn = document.getElementById('undoBtn');
  const redoBtn = document.getElementById('redoBtn');

  if (undoBtn) {
    undoBtn.disabled = !codeEditor.historySize().undo;
  }
  if (redoBtn) {
    redoBtn.disabled = !codeEditor.historySize().redo;
  }
}

// HTML语法验证功能
function validateHTML(htmlCode) {
  const errorIndicator = document.getElementById('errorIndicator');
  const errorText = document.getElementById('errorText');
  const editPreview = document.getElementById('editPreview');
  const codeWrapper = document.querySelector('.CodeMirror');

  try {
    // 创建临时DOM元素验证HTML
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = htmlCode;

    // 基本语法检查
    const errors = [];

    // 检查标签是否配对
    const tagPairs = checkTagPairs(htmlCode);
    if (tagPairs.length > 0) {
      errors.push(`未闭合标签: ${tagPairs.join(', ')}`);
    }

    // 检查属性引号
    const quoteErrors = checkQuotes(htmlCode);
    if (quoteErrors.length > 0) {
      errors.push(`属性引号错误: ${quoteErrors.join(', ')}`);
    }

    if (errors.length > 0) {
      // 显示错误
      errorIndicator.classList.add('show');
      errorText.textContent = errors[0]; // 显示第一个错误
      if (codeWrapper) {
        codeWrapper.classList.add('syntax-error');
      }

      // 尝试更新预览但可能失败
      try {
        editPreview.innerHTML = '';
        const iframe = document.createElement('iframe');
        iframe.setAttribute('frameborder', '0');
        iframe.setAttribute('scrolling', 'no');
        iframe.style.width = '100%';
        iframe.style.height = '100%';
        iframe.style.border = '0';
        iframe.srcdoc = buildIsolatedSrcdoc(htmlCode, 1);
        editPreview.appendChild(iframe);
      } catch (e) {
        editPreview.innerHTML = '<div style="color: #ff6b6b; padding: 20px; text-align: center;">HTML语法错误，无法预览</div>';
      }
    } else {
      // 没有错误
      errorIndicator.classList.remove('show');
      if (codeWrapper) {
        codeWrapper.classList.remove('syntax-error');
      }

      // 更新预览为 iframe 渲染
      editPreview.innerHTML = '';
      const iframe = document.createElement('iframe');
      iframe.setAttribute('frameborder', '0');
      iframe.setAttribute('scrolling', 'no');
      iframe.style.width = '100%';
      iframe.style.height = '100%';
      iframe.style.border = '0';
      iframe.srcdoc = buildIsolatedSrcdoc(htmlCode, 1);
      editPreview.appendChild(iframe);
    }
  } catch (error) {
    // DOM解析错误
    errorIndicator.classList.add('show');
    errorText.textContent = 'HTML语法错误';
    if (codeWrapper) {
      codeWrapper.classList.add('syntax-error');
    }
    editPreview.innerHTML = '<div style="color: #ff6b6b; padding: 20px; text-align: center;">HTML语法错误，无法预览</div>';
  }
}

// 检查标签配对
function checkTagPairs(html) {
  const errors = [];
  const tagRegex = /<\/?([a-zA-Z][a-zA-Z0-9]*)\b[^>]*>/g;
  const stack = [];
  const selfClosingTags = ['img', 'br', 'hr', 'input', 'meta', 'link', 'area', 'base', 'col', 'embed', 'source', 'track', 'wbr'];

  let match;
  while ((match = tagRegex.exec(html)) !== null) {
    const fullTag = match[0];
    const tagName = match[1].toLowerCase();

    if (fullTag.startsWith('</')) {
      // 闭合标签
      if (stack.length === 0) {
        errors.push(tagName);
      } else {
        const lastTag = stack.pop();
        if (lastTag !== tagName) {
          errors.push(`${lastTag} 与 ${tagName} 不匹配`);
        }
      }
    } else if (!fullTag.endsWith('/>') && !selfClosingTags.includes(tagName)) {
      // 开始标签（非自闭合）
      stack.push(tagName);
    }
  }

  // 检查未闭合的标签
  while (stack.length > 0) {
    errors.push(stack.pop());
  }

  return errors;
}

// 检查属性引号
function checkQuotes(html) {
  const errors = [];
  const attrRegex = /(\w+)\s*=\s*([^"'\s>][^\s>]*)/g;

  let match;
  while ((match = attrRegex.exec(html)) !== null) {
    errors.push(`属性 ${match[1]} 缺少引号`);
  }

  return errors;
}

// 预览缩放控制功能
function zoomPreview(delta) {
  currentZoom = Math.max(0.25, Math.min(2, currentZoom + delta)); // 限制在25%-200%之间
  updatePreviewZoom();
}

function resetZoom() {
  currentZoom = 0.75; // 重置为75%
  updatePreviewZoom();
}

function updatePreviewZoom() {
  const editPreview = document.getElementById('editPreview');
  const zoomText = document.getElementById('zoomText');
  const zoomOutBtn = document.getElementById('zoomOutBtn');
  const zoomInBtn = document.getElementById('zoomInBtn');

  if (editPreview) {
    editPreview.style.transform = `scale(${currentZoom})`;
  }

  if (zoomText) {
    zoomText.textContent = Math.round(currentZoom * 100) + '%';
  }

  // 更新按钮状态
  if (zoomOutBtn) {
    zoomOutBtn.disabled = currentZoom <= 0.25;
  }
  if (zoomInBtn) {
    zoomInBtn.disabled = currentZoom >= 2;
  }
}

// 列表自适应缩放刷新，仅作用于外层列表
function refreshListPreviewScale() {
  const listRoot = document.getElementById('generatedPics');
  if (!listRoot) return;
  const shells = listRoot.querySelectorAll('.iframe-shell');
  shells.forEach(shell => {
    const iframe = shell.querySelector('iframe');
    if (!iframe) return;
    const raw = shell.dataset.rawHtml || '';
    const width = shell.getBoundingClientRect().width || 450;
    const scale = width / 600;
    // 仅列表使用 buildListSrcdoc，不影响弹窗
    iframe.srcdoc = buildListSrcdoc(raw || iframe.srcdoc, scale);
  });
}
window.addEventListener('resize', () => {
  clearTimeout(window.__listScaleTimer);
  window.__listScaleTimer = setTimeout(refreshListPreviewScale, 120);
});
// 首图插入后异步刷新一次
setTimeout(refreshListPreviewScale, 0);

// 保留原生textarea的实时预览功能作为备用
document.getElementById('editCode').addEventListener('input', function(e) {
  // 这个事件只在CodeMirror未初始化时生效
  if (!codeEditor) {
    const editPreview = document.getElementById('editPreview');
    const code = e.target.value;

    try {
      editPreview.innerHTML = '';
      const iframe = document.createElement('iframe');
      iframe.setAttribute('frameborder', '0');
      iframe.setAttribute('scrolling', 'no');
      iframe.style.width = '100%';
      iframe.style.height = '100%';
      iframe.style.border = '0';
      iframe.srcdoc = buildIsolatedSrcdoc(code, 1);
      editPreview.appendChild(iframe);
    } catch (error) {
      console.error('预览更新失败:', error);
    }
  }
});

// ESC键关闭弹窗
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    const modal = document.getElementById('editModal');
    if (modal.classList.contains('active')) {
      closeEditModal();
    }
  }
});

// 点击弹窗背景关闭
document.getElementById('editModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeEditModal();
  }
});
</script>
{% endblock %}