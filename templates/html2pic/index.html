{% extends "_base.html" %}

{% block title %}小红书图片文案生成{% endblock %}

{% block head %}
<style>
  .redbook-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
    max-width: 1400px;
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 30px;
    box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
  }

  .redbook-area {
    display: flex;
    justify-content: center;
    align-items: flex-start;
    width: 100%;
    gap: 30px;
  }

  .input-container {
    flex: 1;
    max-width: 400px;
  }

  .input-textarea {
    width: 100%;
    min-height: 300px;
    border: 1px solid rgba(255, 255, 255, 0.18);
    background-color: rgba(255, 255, 255, 0.05);
    color: #e3e3e3;
    border-radius: 12px;
    padding: 16px;
    font-size: 16px;
    resize: vertical;
    transition: all 0.3s ease;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  }

  .input-textarea:focus {
    outline: none;
    box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.6);
  }

  .output-container {
    flex: 2;
    max-width: 800px;
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .generated-text {
    background: rgba(255, 255, 255, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.18);
    border-radius: 12px;
    padding: 16px;
    color: #e3e3e3;
    font-size: 16px;
    line-height: 1.6;
    white-space: pre-wrap;
    min-height: 120px;
    display: none;
  }

  .generated-pics {
    display: flex;
    flex-direction: column;
    gap: 15px;
  }

  .pic-item {
    background: rgba(255, 255, 255, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.18);
    border-radius: 12px;
    padding: 20px;
    overflow: hidden;
  }

  .generate-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 12px;
    padding: 12px 24px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: 15px;
    min-width: 120px;
  }

  .generate-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
  }

  .generate-btn:disabled {
    background: rgba(255, 255, 255, 0.1);
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  .loading {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s ease-in-out infinite;
    margin-right: 8px;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  label {
    color: #a5b4fc;
    margin-bottom: 8px;
    display: block;
    font-weight: 500;
    text-shadow: 0 0 3px #a5b4fc;
  }

  .status-text {
    color: #10b981;
    font-size: 14px;
    margin-top: 10px;
    display: none;
  }

  /* 响应式设计 */
  @media (max-width: 1024px) {
    .redbook-area {
      flex-direction: column;
      gap: 20px;
    }

    .input-container,
    .output-container {
      max-width: 100%;
      width: 100%;
    }
  }

  @media (max-width: 768px) {
    .redbook-content {
      padding: 20px;
    }

    .input-textarea {
      min-height: 200px;
    }
  }
</style>
{% endblock %}

{% block body %}
<div class="container">
  <a href="{{ url_for('main.home') }}" class="home-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6">
      <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
      <polyline points="9 22 9 12 15 12 15 22"></polyline>
    </svg>
  </a>

  <div class="redbook-content">
    <h1 class="title">小红书图片文案生成</h1>

    <div class="redbook-area">
      <!-- 左侧输入区域 -->
      <div class="input-container">
        <label for="textInput">输入文案内容</label>
        <textarea
          id="textInput"
          class="input-textarea"
          placeholder="请输入你想要生成小红书内容的原始文案..."
        ></textarea>
        <button id="generateBtn" class="generate-btn" onclick="generateRedbook()">
          生成
        </button>
        <div id="statusText" class="status-text"></div>
      </div>

      <!-- 右侧输出区域 -->
      <div class="output-container">
        <!-- 生成的文案 -->
        <div>
          <label>生成的文案</label>
          <div id="generatedText" class="generated-text"></div>
        </div>

        <!-- 生成的图片 -->
        <div>
          <label>生成的图片</label>
          <div id="generatedPics" class="generated-pics">
            <!-- 动态生成的图片内容会插入到这里 -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>

// 自动调整textarea高度
function autoResize(textarea) {
  textarea.style.height = 'auto';
  textarea.style.height = (textarea.scrollHeight) + 'px';
}

// 为输入框添加自动调整高度功能
document.getElementById('textInput').addEventListener('input', function() {
  autoResize(this);
});

// 为输入框添加回车快捷键
document.getElementById('textInput').addEventListener('keydown', function(e) {
  if (e.ctrlKey && e.key === 'Enter') {
    e.preventDefault();
    generateRedbook();
  }
});

function generateRedbook() {
  const textInput = document.getElementById('textInput');
  const generateBtn = document.getElementById('generateBtn');
  const statusText = document.getElementById('statusText');
  const generatedText = document.getElementById('generatedText');
  const generatedPics = document.getElementById('generatedPics');

  const textContent = textInput.value.trim();

  if (!textContent) {
    showToast('请输入文案内容', 'warning');
    return;
  }

  // 重置输出区域
  generatedText.style.display = 'none';
  generatedText.textContent = '';
  generatedPics.innerHTML = '';

  // 更新按钮状态
  generateBtn.disabled = true;
  generateBtn.innerHTML = '<span class="loading"></span>生成中...';
  statusText.style.display = 'block';
  statusText.textContent = '正在连接服务器...';

  // 注意：使用fetch API，连接会自动管理

  // 使用fetch API处理SSE流
  const url = '/html2pic/generate_redbook';
  const requestData = {
    text_content: textContent
  };

  fetch(url, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(requestData)
  }).then(response => {
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const reader = response.body.getReader();
    const decoder = new TextDecoder();

    function processText({ done, value }) {
      if (done) {
        console.log('SSE流结束');
        return;
      }

      const chunk = decoder.decode(value, { stream: true });
      const lines = chunk.split('\n');

      for (let line of lines) {
        if (line.startsWith('data: ')) {
          try {
            const jsonStr = line.substring(6); // 去掉 "data: " 前缀
            if (jsonStr.trim()) {
              const data = JSON.parse(jsonStr);
              console.log('收到数据:', data);

              switch(data.type) {
                case 'heartbeat':
                  statusText.textContent = data.content;
                  break;

                case 'text':
                  // 显示生成的文案
                  generatedText.textContent = data.content;
                  generatedText.style.display = 'block';
                  statusText.textContent = '文案生成完成，正在生成图片...';
                  break;

                case 'pic':
                  // 显示生成的图片HTML
                  const picItem = document.createElement('div');
                  picItem.className = 'pic-item';
                  picItem.innerHTML = data.content;
                  generatedPics.appendChild(picItem);
                  statusText.textContent = `已生成 ${generatedPics.children.length} 张图片...`;
                  break;

                case 'done':
                  // 生成完成
                  statusText.textContent = '所有内容生成完成！';
                  resetButton();
                  showToast('生成完成！', 'success');
                  return;

                default:
                  console.log('未知消息类型:', data.type);
              }
            }
          } catch (error) {
            console.error('解析SSE数据失败:', error, '原始数据:', line);
          }
        }
      }

      // 继续读取下一块数据
      return reader.read().then(processText);
    }

    return reader.read().then(processText);
  }).catch(error => {
    console.error('请求失败:', error);
    statusText.textContent = '请求失败';
    resetButton();
    showToast('生成过程中出现错误，请重试', 'error');
  });
}

function resetButton() {
  const generateBtn = document.getElementById('generateBtn');
  const statusText = document.getElementById('statusText');

  generateBtn.disabled = false;
  generateBtn.innerHTML = '生成';

  setTimeout(() => {
    statusText.style.display = 'none';
  }, 3000);
}

// 页面卸载时的清理工作（fetch API会自动处理）
</script>
{% endblock %}